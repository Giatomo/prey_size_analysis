# Downstream analysis & plotting of TdTomato *B. bacteriovorus* with *E. coli* prey grown in LB

## Library loading

```{r}
library(tidyverse)
library(sf)
```

## Parameters

```{r}
n_bins <- 3
condition_order <- c("WT", "Joe", "William", "Averell") # TODO ? change into the proper strain names ?
save_format <- "csv" # TODO ? Add choice of output and change function with a save_fct<- switch(save_format, ...)
```

## Data loading

Load .rds data from the prey size analysis pipeline & also load .rds data containing info on cell to discard after manual checking of outliers cells.

```{r}
analysis_folder <- "E:/Yoann/IGR_all/" |> fs::path()

# Pipeline output
if (fs::file_exists(analysis_folder/"meshes_ids.rds")) {
  meshes <- readRDS(analysis_folder/"meshes_ids.rds")}
if (fs::file_exists(analysis_folder/"growing_cells.rds")) {
  growing_cells <- readRDS(analysis_folder/"growing_cells.rds")}
if (fs::file_exists(analysis_folder/"popping_frames.rds")) {
  popping_frames <- readRDS(analysis_folder/"popping_frames.rds")}
if (fs::file_exists(analysis_folder/"phase_intensity_summary.rds")) {
  phase_intensity_summary <- readRDS(analysis_folder/"phase_intensity_summary.rds")}

# Data issued from manual curation
if (fs::file_exists(analysis_folder/"bad_early.rds")) {
  bad_early <- readRDS(analysis_folder / "bad_early.rds")}
if (fs::file_exists(analysis_folder/"bad_late.rds")) {
  bad_late <- readRDS(analysis_folder / "bad_late.rds")}

```

## Data merging

Merge data from the outline file (id, bdelloplast outline, condition, replicate, bdelloplast area) with popping point data (id, popping frame/time), diffuse signal (id, bdellovibrio area, frame/time, end of growth) & discard the "bad" cells

```{r}
meshes |> 
  # Discard id from manually curated data
  filter(!id %in% c(bad_early, bad_late)) |>
  # Join all the data together 
  inner_join(popping_frames, by = "id") |>
  inner_join(growing_cells, by = "id") |>
  as_tibble() -> TdTomato_LB

# TODO rename area in pipeline to either bdelloplast_area or prey_area

TdTomato_LB |> 
  # Keep only one line of data for each id to create the bins
  # Avoid having and impact of the number of frames when creating *n_bins* bins of the same size 
  group_by(id) |>
  slice_head(n = 1) |>
  ungroup() |>
  mutate(
    bin_prey_area = santoku::chop_equally(prey_area, n_bins)) |>
  select(id, bin_prey_area) -> TdTomato_LB_bins

```

## Data cleaning

```{r}

TdTomato_LB |> 
  inner_join(TdTomato_LB_bins, by = "id") |> 
  mutate(
    time = frame * 8, # TODO move into pipeline
    popping_time = popping_frame * 8,  # TODO move into pipeline
    log_bdello_area_um2 = log(area_um2),
    pop_area = popping_time / area,
    pop_log_area = popping_time / log_bdello_area_um2,
    difference_popping_point_end_of_growth_frame = popping_frame - first_peak,
    difference_popping_point_end_of_growth_min   = difference_popping_point_end_of_growth_frame * 8,
    condition = fct_relevel(condition, condition_order)) -> TdTomato_LB

# TODO select the most useful infos


```

## Downstream analysis (can be moved to the pipeline)

Compute the specific growth rate (µ) of B. bacteriovorus filaments by fitting a linear model : $ln(area_{prey})(t) = µ \cdot t + ln(area_{prey_{0}})$

```{r}
TdTomato_LB |> 
  group_by(id) |>
  filter(!is.infinite(log_bdello_area_um2)) |> 
  nest(data = -id) |>
  # Fit lm  and get  the slope
  # TODO Might be useful to keep/add more info (goodness of fit, intercept, etc)
  mutate(
    sgr_min = map_dbl(data, \(data) lm(log_bdello_area_um2 ~ time, data = data)$coefficients[[2]]),
    sgr_h = sgr_min*60) -> specific_growth_rate

TdTomato_LB |> inner_join(specific_growth_rate, by = "id") -> TdTomato_LB


# Maybe we should just group this result with the main data and save only once (will also simplifies the descriptive statistics)


```

### Saving

```{r}
# TODO select the most useful infos
TdTomato_LB |> write_csv(file = analysis_folder / "TdTomato_LB.csv")
```

## Descriptive statistics (Summarized data)

Compute the descriptive statistics (mean, SD, CV, median, mad, rCV) of the data across everything, condition, bins of the prey area

-   Data \|\> group() \|\> summarize() -\> *uniform way of naming with data name and group* (for plotting the statistics)

*uniform way of naming with data name and group \|\>* pivot_longer() -\> show & save (for easier reading)

### Across all data

```{r}
# TODO make sure everything interesting is summarized 
# TODO add sgr to the summary 
TdTomato_LB |>
  group_by(id) |> slice_head(n = 1) |> ungroup() |>
  summarise(
    n = n(),
    across(
      c(popping_time,
        first_peak,
        start_size,
        central_size,
        end_size,
        difference_popping_point_end_of_growth_min,
      ),
      summarise_fcts,
      .names = "{.col}_{.fn}")) -> TdTomato_LB_over_all


TdTomato_LB_over_all |>
  pivot_longer(
    cols = -n,
    names_to = c("variable", ".value"),
    names_pattern = "(\\w+)_(\\w+)")

```

### Across strains (condition)

```{r}

```

### Across replicates (should be important)

```{r}

```

### Across strain & replicates (also important)

```{r}

```

### Across prey size bins

```{r}

```

### Saving

```{r}
# TODO do a loop or a purrr::walk
TdTomato_LB_over_all |> write_csv(file = analysis_folder / "TdTomato_LB_over_all.csv")

```

## Data plotting

### Popping point

```{r}
# TODO Make sure overall plots parts are rougthly in the same order
# Should we add someting like a pch over replicates or another plot with color = replicate ?
# Maybe we should make a list like that (plot_name = plot) maybe nested (not sure) so we can loop / purrr::walk to save

# Popping time/prey area scatter plot
TdTomato_LB |>
  ggplot(aes(
    x = area,
    y = popping_time,
    color = condition)) +
  geom_point() + 
  theme_classic() + 
  theme(aspect.ratio=1) + 
  ylim(0,600)
```

### End of growth

```{r}

```

### Popping point - end of growth

```{r}

```

### Individual growth

```{r}

```

### Specific growth rate

```{r}

```

### Saving

```{r}

```
